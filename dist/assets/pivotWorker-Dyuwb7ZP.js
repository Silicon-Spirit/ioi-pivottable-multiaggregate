(function(){"use strict";const f=typeof window<"u"&&window.__?window.__:(t,e)=>e&&e.length?t.replace(/\{(\d+)\}/g,(s,r)=>e[parseInt(r)]||s):t,U=function(t,e,s){const r=String(t).split(".");let n=r[0];const o=r.length>1?s+r[1]:"",i=/(\d+)(\d{3})/;for(;i.test(n);)n=n.replace(i,`$1${e}$2`);return n+o},P=()=>{if(typeof window>"u"||!window.get_number_format||!window.get_number_format_info)return{thousandsSep:",",decimalSep:".",digitsAfterDecimal:2};const t=window.get_number_format(),e=window.get_number_format_info(t);return{thousandsSep:e.group_sep,decimalSep:e.decimal_str,digitsAfterDecimal:e.precision}},j=function(t){const e=P(),s={digitsAfterDecimal:e.digitsAfterDecimal,scaler:1,thousandsSep:e.thousandsSep,decimalSep:e.decimalSep,prefix:"",suffix:""},r=Object.assign({},s,t);return function(n){if(isNaN(n)||!isFinite(n))return"";const o=U((r.scaler*n).toFixed(r.digitsAfterDecimal),r.thousandsSep,r.decimalSep);return`${r.prefix}${o}${r.suffix}`}},D=/(\d+)|(\D+)/g,k=/\d/,V=/^0/,x=(t,e)=>{if(e!==null&&t===null)return-1;if(t!==null&&e===null)return 1;if(typeof t=="number"&&isNaN(t))return-1;if(typeof e=="number"&&isNaN(e))return 1;const s=Number(t),r=Number(e);if(s<r)return-1;if(s>r)return 1;if(typeof t=="number"&&typeof e!="number")return-1;if(typeof e=="number"&&typeof t!="number")return 1;if(typeof t=="number"&&typeof e=="number")return 0;if(isNaN(r)&&!isNaN(s))return-1;if(isNaN(s)&&!isNaN(r))return 1;let n=String(t),o=String(e);if(n===o)return 0;if(!k.test(n)||!k.test(o))return n>o?1:-1;for(n=n.match(D),o=o.match(D);n.length&&o.length;){const i=n.shift(),a=o.shift();if(i!==a)return k.test(i)&&k.test(a)?i.replace(V,".0")-a.replace(V,".0"):i>a?1:-1}return n.length-o.length},E=function(t,e){if(t){if(typeof t=="function"){const s=t(e);if(typeof s=="function")return s}else if(e in t)return t[e]}return x},A=j(),q=j({digitsAfterDecimal:0}),F=j({digitsAfterDecimal:1,scaler:100,suffix:"%"}),h={count(t=q){return()=>function(e,s,r){return{count:0,push(){this.count++},value(){return this.count},format:t,numInputs:0}}},uniques(t,e=q){return function([s]){return function(r,n,o){const i=s;return{uniq:[],push(a){if(i==null)return;const l=a[i];let u=!0;for(let c=0;c<this.uniq.length;c++){const g=this.uniq[c];if(typeof l=="number"&&typeof g=="number"&&isNaN(l)&&isNaN(g)){u=!1;break}if(l===g){u=!1;break}}u&&this.uniq.push(l)},getUniqArray(){return this.uniq},value(){if(this.uniq&&this.uniq.length>0&&typeof t=="function"){const a=t(this.uniq);return i&&this.uniq.length>0&&(typeof a=="string"&&a.includes(",")||this.uniq.length===1&&i.includes("mark")),a}return""},format:e,numInputs:typeof i<"u"?0:1}}}},sum(t=A){return function([e]){return function(s,r,n){return{sum:0,push(o){if(e==null)return;const i=o[e];i!=null&&!isNaN(parseFloat(i))&&(this.sum+=parseFloat(i))},value(){return this.sum},format:t,numInputs:typeof e<"u"?0:1}}}},extremes(t,e=A){return function([s]){return function(r,n,o){return{val:null,sorter:E(typeof r<"u"?r.sorters:null,s),push(i){if(s==null)return;let a=i[s];a!=null&&(["min","max"].includes(t)&&(a=parseFloat(a),isNaN(a)||(this.val=Math[t](a,this.val!==null?this.val:a))),t==="first"&&this.sorter(a,this.val!==null?this.val:a)<=0&&(this.val=a),t==="last"&&this.sorter(a,this.val!==null?this.val:a)>=0&&(this.val=a))},value(){return this.val},format(i){return isNaN(i)?i:e(i)},numInputs:typeof s<"u"?0:1}}}},quantile(t,e=A){return function([s]){return function(r,n,o){return{vals:[],push(i){if(s==null)return;const a=i[s];if(a==null)return;const l=parseFloat(a);isNaN(l)||this.vals.push(l)},value(){if(this.vals.length===0)return null;this.vals.sort((a,l)=>a-l);const i=(this.vals.length-1)*t;return(this.vals[Math.floor(i)]+this.vals[Math.ceil(i)])/2},format:e,numInputs:typeof s<"u"?0:1}}}},runningStat(t="mean",e=1,s=A){return function([r]){return function(n,o,i){return{n:0,m:0,s:0,push(a){if(r==null)return;const l=a[r];if(l==null)return;const u=parseFloat(l);if(isNaN(u))return;this.n+=1,this.n===1&&(this.m=u);const c=this.m+(u-this.m)/this.n;this.s=this.s+(u-this.m)*(u-c),this.m=c},value(){if(t==="mean")return this.n===0?NaN:this.m;if(this.n<=e)return 0;switch(t){case"var":return this.s/(this.n-e);case"stdev":return Math.sqrt(this.s/(this.n-e));default:throw new Error(f("unknown mode for runningStat"))}},format:s,numInputs:typeof r<"u"?0:1}}}},sumOverSum(t=A){return function([e,s]){return function(r,n,o){return{sumNum:0,sumDenom:0,push(i){if(e!=null){const a=i[e];a!=null&&!isNaN(parseFloat(a))&&(this.sumNum+=parseFloat(a))}if(s!=null){const a=i[s];a!=null&&!isNaN(parseFloat(a))&&(this.sumDenom+=parseFloat(a))}},value(){return this.sumDenom!==0?this.sumNum/this.sumDenom:0},format:t,numInputs:2}}}},fractionOf(t,e="total",s=F){return(...r)=>{const o=t(...Array.from(r||[]))().numInputs;return function(i,a,l){return{selector:{total:[[],[]],row:[a,[]],col:[[],l]}[e],inner:t(...Array.from(r||[]))(i,a,l),push(u){this.inner.push(u)},format:s,value(){const u=this.selector||[],c=i.getAggregator(...Array.from(u));let g=c;if(c&&typeof c=="object"&&!c.inner&&!c.value){const S=[f("Sum"),f("Integer Sum"),f("Count"),f("Average")];for(const d of S)if(c[d]&&typeof c[d].value=="function"){g=c[d];break}if(!g||typeof g=="object"&&!g.value){const d=i.getAggregatorNames();for(const T of d)if(c[T]&&typeof c[T].value=="function"&&!c[T].inner){g=c[T];break}}}let p=0;g&&(g.inner&&typeof g.inner.value=="function"?p=g.inner.value():typeof g.value=="function"&&(p=g.value()));const _=this.inner.value();return p===0||p===null||p===void 0?0:_/p},numInputs:o}}}}};h.countUnique=t=>h.uniques(e=>e.length,t),h.listUnique=t=>h.uniques(e=>e.join(t),e=>e),h.max=t=>h.extremes("max",t),h.min=t=>h.extremes("min",t),h.first=t=>h.extremes("first",t),h.last=t=>h.extremes("last",t),h.median=t=>h.quantile(.5,t),h.average=t=>h.runningStat("mean",1,t),h.var=(t,e)=>h.runningStat("var",t,e),h.stdev=(t,e)=>h.runningStat("stdev",t,e);let I=(t=>({Count:t.count(q),"Count Unique Values":t.countUnique(q),"List Unique Values":t.listUnique(", "),Sum:t.sum(A),"Integer Sum":t.sum(q),Average:t.average(A),Median:t.median(A),"Sample Variance":t.var(1,A),"Sample Standard Deviation":t.stdev(1,A),Minimum:t.min(A),Maximum:t.max(A),First:t.first(A),Last:t.last(A),"Sum over Sum":t.sumOverSum(A),"Sum as Fraction of Total":t.fractionOf(t.sum(),"total",F),"Sum as Fraction of Rows":t.fractionOf(t.sum(),"row",F),"Sum as Fraction of Columns":t.fractionOf(t.sum(),"col",F),"Count as Fraction of Total":t.fractionOf(t.count(),"total",F),"Count as Fraction of Rows":t.fractionOf(t.count(),"row",F),"Count as Fraction of Columns":t.fractionOf(t.count(),"col",F)}))(h),L={};Object.keys(I).forEach(t=>{L[f(t)]=I[t]}),I=L,f("An error occurred rendering the PivotTable results."),f("An error occurred computing the PivotTable results."),f("An error occurred rendering the PivotTable UI."),f("Select All"),f("Select None"),f("(too many to list)"),f("Filter values"),f("Apply"),f("Cancel"),f("Totals"),f("vs"),f("by"),f("Jan"),f("Feb"),f("Mar"),f("Apr"),f("May"),f("Jun"),f("Jul"),f("Aug"),f("Sep"),f("Oct"),f("Nov"),f("Dec"),f("Sun"),f("Mon"),f("Tue"),f("Wed"),f("Thu"),f("Fri"),f("Sat");const $={data:[],rows:[],cols:[],vals:[],aggregatorName:"Count",aggregatorNames:[],aggregatorVals:{},aggregators:I,valueFilter:{},derivedAttributes:{},sorters:{},rowOrder:"key_a_to_z",colOrder:"key_a_to_z"};function M(){return{push(){},value(){return null},format(){return""}}}function W(t,e,s){let r,n;if(Object.getOwnPropertyNames(e).length===0?r=s:r=function(o){for(const i in e){const a=e[i](o);a!==null&&(o[i]=a)}return s(o)},typeof t=="function")return t(r);if(Array.isArray(t))if(Array.isArray(t[0]))for(let o=1;o<t.length;o++){const i=t[o];n={};for(let a=0;a<t[0].length;a++){const l=t[0][a];n[l]=i[a]}r(n)}else for(let o=0;o<t.length;o++)n=t[o],n&&typeof n=="object"&&r(n)}class H{constructor(e={}){this.props=Object.assign({},$,e),this.aggregatorNames=this.resolveAggregatorNames();const s=this.props.aggregatorVals||{};if(this.aggregatorFactories=this.aggregatorNames.map(r=>{const n=this.props.aggregators[r];if(typeof n!="function")return null;const o=s[r]||this.props.vals||[],i=n(o);return typeof i!="function"?null:{name:r,factory:i}}).filter(Boolean),!this.aggregatorFactories.length){const r=Object.keys(this.props.aggregators)[0];if(r){const o=(this.props.aggregatorVals||{})[r]||this.props.vals||[],i=this.props.aggregators[r](o);this.aggregatorFactories.push({name:r,factory:i}),this.aggregatorNames=[r]}}this.aggregatorNames=this.aggregatorFactories.map(r=>r.name),this.primaryAggregatorName=this.aggregatorNames[0]||null,this.tree={},this.rowKeys=[],this.colKeys=[],this.rowTotals={},this.colTotals={},this.allTotal=this.createAggregatorCollection([],[]),this.sorted=!1,W(this.props.data,this.props.derivedAttributes,r=>{this.filter(r)&&this.processRecord(r)})}resolveAggregatorNames(){let e=[];if(Array.isArray(this.props.aggregatorNames)&&this.props.aggregatorNames.length?e=this.props.aggregatorNames.slice():Array.isArray(this.props.aggregatorName)?e=this.props.aggregatorName.slice():typeof this.props.aggregatorName=="string"&&this.props.aggregatorName&&(e=[this.props.aggregatorName]),!e.length){const s=Object.keys(this.props.aggregators)[0];s&&(e=[s])}return e.filter((s,r,n)=>n.indexOf(s)===r)}createAggregatorCollection(e,s){const r={};for(const n of this.aggregatorFactories){const{name:o,factory:i}=n;r[o]=i(this,e,s)}return!Object.keys(r).length&&this.primaryAggregatorName&&(r[this.primaryAggregatorName]=M()),r}createEmptyCollection(){const e={};for(const s of this.aggregatorNames)e[s]=M();return e}pushRecord(e,s){if(e)for(const r in e){const n=e[r];n&&typeof n.push=="function"&&n.push(s)}}filter(e){for(const s in this.props.valueFilter){const r=e[s];if((r==null||!(s in e)?"null":r)in this.props.valueFilter[s])return!1}return!0}processRecord(e){const s=this.props.cols,r=this.props.rows,n=[],o=[],i="\0";for(let u=0,c=s.length;u<c;u++){const g=s[u],p=e[g];n.push(p==null||!(g in e)?"null":p)}for(let u=0,c=r.length;u<c;u++){const g=r[u],p=e[g];o.push(p==null||!(g in e)?"null":p)}const a=o.join(i),l=n.join(i);this.pushRecord(this.allTotal,e),o.length!==0&&(this.rowTotals[a]||(this.rowKeys.push(o),this.rowTotals[a]=this.createAggregatorCollection(o,[])),this.pushRecord(this.rowTotals[a],e)),n.length!==0&&(this.colTotals[l]||(this.colKeys.push(n),this.colTotals[l]=this.createAggregatorCollection([],n)),this.pushRecord(this.colTotals[l],e)),n.length!==0&&o.length!==0&&(this.tree[a]||(this.tree[a]={}),this.tree[a][l]||(this.tree[a][l]=this.createAggregatorCollection(o,n)),this.pushRecord(this.tree[a][l],e))}getAggregatorCollection(e,s){const r=e.join("\0"),n=s.join("\0");let o;return e.length===0&&s.length===0?o=this.allTotal:e.length===0?o=this.colTotals[n]:s.length===0?o=this.rowTotals[r]:o=this.tree[r]&&this.tree[r][n]?this.tree[r][n]:null,o||this.createEmptyCollection()}getAggregator(e,s,r){const n=this.getAggregatorCollection(e,s);if(typeof r=="string"&&r)return n[r]?n[r]:M();if(this.aggregatorNames.length===1){const o=this.aggregatorNames[0];return n[o]||M()}return n}getAggregatorNames(){return this.aggregatorNames.slice()}getRowKeys(){return this.sortKeys(),this.rowKeys}getColKeys(){return this.sortKeys(),this.colKeys}arrSort(e){const s=[];for(let r=0;r<e.length;r++)s.push(E(this.props.sorters,e[r]));return function(r,n){for(let o=0;o<s.length;o++){const i=s[o],a=i(r[o],n[o]);if(a!==0)return a}return 0}}sortKeys(){if(this.sorted)return;this.sorted=!0;const e=this.primaryAggregatorName||this.aggregatorNames[0]||null,s=(r,n)=>{const o=e?this.getAggregator(r,n,e):this.getAggregator(r,n);return o&&typeof o.value=="function"?o.value():null};switch(this.props.rowOrder){case"value_a_to_z":this.rowKeys.sort((r,n)=>x(s(r,[]),s(n,[])));break;case"value_z_to_a":this.rowKeys.sort((r,n)=>-x(s(r,[]),s(n,[])));break;default:this.rowKeys.sort(this.arrSort(this.props.rows))}switch(this.props.colOrder){case"value_a_to_z":this.colKeys.sort((r,n)=>x(s([],r),s([],n)));break;case"value_z_to_a":this.colKeys.sort((r,n)=>-x(s([],r),s([],n)));break;default:this.colKeys.sort(this.arrSort(this.props.cols))}}}function z(t,e){if(!t||t.length===0)return[];if(e>=t.length||e<3)return t;const s=t.map((l,u)=>Array.isArray(l)?{x:l[0],y:l[1],index:u}:typeof l=="number"?{x:u,y:l,index:u}:{x:l.x||u,y:l.y||l.value||0,index:u}),r=s.length,n=[],o=(r-2)/(e-2);let i=0,a=0;n.push(s[i]);for(let l=0;l<e-2;l++){const u=Math.floor((l+1)*o)+1,c=Math.floor((l+2)*o)+1,g=c-u;let p=0,_=0;for(let m=u;m<c;m++)p+=s[m].x,_+=s[m].y;p/=g,_/=g;const S=Math.floor((l+0)*o)+1,d=Math.floor((l+1)*o)+1,T=s[i].x,R=s[i].y;let K=-1;for(let m=S;m<d;m++){const w=Math.abs((T-p)*(s[m].y-R)-(T-s[m].x)*(_-R));w>K&&(K=w,a=m)}n.push(s[a]),i=a}return n.push(s[r-1]),n.map(l=>Array.isArray(t[0])?[l.x,l.y]:typeof t[0]=="number"?l.y:{x:l.x,y:l.y})}function J(t,e=500){if(!t||!t.labels||!t.datasets)return t;const{labels:s,datasets:r}=t;if(s.length<=e)return t;const o=r.map(u=>{const c=s.map((S,d)=>({x:d,y:typeof u.values[d]=="number"?u.values[d]:parseFloat(u.values[d])||0})),g=z(c,e);g.map(S=>S.x).map(S=>s[S]);const _=g.map(S=>S.y);return{...u,values:_}}),i=s.map((u,c)=>c);return{labels:z(i.map(u=>({x:u,y:0})),e).map(u=>s[u.x]),datasets:o}}self.onmessage=async t=>{const{id:e,type:s,payload:r}=t.data;if(s==="CALCULATE_PIVOT")try{const{data:n,rows:o,cols:i,vals:a,aggregatorNames:l,aggregatorVals:u,valueFilter:c,derivedAttributes:g,sorters:p,rowOrder:_,colOrder:S}=r,d=new H({data:n,rows:o,cols:i,vals:a,aggregatorNames:l,aggregatorVals:u,aggregators:I,valueFilter:c,derivedAttributes:{},sorters:{},rowOrder:_,colOrder:S}),T=d.getRowKeys(),R=d.getColKeys(),K=d.getAggregatorNames(),m={rowKeys:T,colKeys:R,aggregatorNames:K,tree:{},rowTotals:{},colTotals:{},allTotal:{}};for(const w of T){const v=w.join("\0");m.tree[v]={};for(const N of R){const y=N.join("\0");m.tree[v][y]={};for(const b of K){const C=d.getAggregator(w,N,b),O=C&&typeof C.value=="function"?C.value():null,Z=C&&typeof C.format=="function"?C.format(O):O!=null?String(O):"";m.tree[v][y][b]={value:O,formatted:Z}}}}for(const w of T){const v=w.join("\0");m.rowTotals[v]={};for(const N of K){const y=d.getAggregator(w,[],N);if(y&&typeof y.value=="function"){const b=y.value(),C=N.split("(")[0].trim().toLowerCase();C.includes("list")&&C.includes("unique");const O=y&&typeof y.format=="function"?y.format(b):b!=null?String(b):"";m.rowTotals[v][N]={value:b,formatted:O}}else m.rowTotals[v][N]={value:null,formatted:""}}}for(const w of R){const v=w.join("\0");m.colTotals[v]={};for(const N of K){const y=d.getAggregator([],w,N),b=y&&typeof y.value=="function"?y.value():null,C=y&&typeof y.format=="function"?y.format(b):b!=null?String(b):"";m.colTotals[v][N]={value:b,formatted:C}}}for(const w of K){const v=d.getAggregator([],[],w),N=v&&typeof v.value=="function"?v.value():null,y=v&&typeof v.format=="function"?v.format(N):N!=null?String(N):"";m.allTotal[w]={value:N,formatted:y}}self.postMessage({id:e,type:"PIVOT_CALCULATED",result:m})}catch(n){self.postMessage({id:e,type:"ERROR",error:n.message,stack:n.stack})}else if(s==="OPTIMIZE_CHART_DATA")try{const{chartData:n,chartType:o,lttbThreshold:i}=r;if((o==="line"||o==="bar")&&n&&n.labels&&n.labels.length>i){const a=J(n,i);self.postMessage({id:e,type:"CHART_DATA_OPTIMIZED",chartData:a})}else self.postMessage({id:e,type:"CHART_DATA_OPTIMIZED",chartData:n})}catch(n){self.postMessage({id:e,type:"ERROR",error:n.message,stack:n.stack})}}})();
//# sourceMappingURL=pivotWorker-Dyuwb7ZP.js.map
